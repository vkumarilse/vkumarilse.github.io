{
  "$schema": "https://vega.github.io/schema/vega-lite/v6.2.json",
  "description": "Choropleth map showing Wales population density at MSOA level from 2021 Census data using logarithmic orange scale.",
  "title": "Wales Population Density by MSOA (2021 Census)",
  "width": 350,
  "height": 450,
  "data": {
    "url": "https://raw.githubusercontent.com/jhellingsdata/RADataHub/refs/heads/main/MappingWorkshop/geo_data/Wales_MSOA.topojson",
    "format": {"type": "topojson", "feature": "data"}
  },
  "params": [
    {
      "name": "income_selection",
      "value": "before",
      "bind": {
        "input": "select",
        "options": ["before", "after"],
        "labels": ["Before Housing Costs", "After Housing Costs"],
        "name": "Show Income: "
      }
    }
  ],
  "transform": [
    {
      "lookup": "properties.MSOA21CD",
      "from": {
        "data": {
          "url": "https://raw.githubusercontent.com/vkumarilse/vkumarilse.github.io/main/dataset/welsh_income_housing.csv"
        },
        "key": "msoa_code",
        "fields": [
          "income_before_housing",
          "income_after_housing",
          "housing_cost",
          "housing_cost_pct"
        ]
      }
    },
    {
      "calculate": "income_selection == 'before' ? datum.income_before_housing : datum.income_after_housing",
      "as": "selected_income"
    },
    {
      "calculate": "income_selection == 'before' ? 'Before Housing Costs' : 'After Housing Costs'",
      "as": "income_label"
    }
  ],
  "mark": {"type": "geoshape", "stroke": "white", "strokeWidth": 0.5},
  "encoding": {
    "color": {
      "field": "selected_income",
      "type": "quantitative",
      "scale": {"scheme": "darkgold", "domain": [20, 52]},
      "title": "Income (£000s)"
    },
    "tooltip": [
      {"field": "properties.MSOA21NM", "type": "nominal", "title": "MSOA"},
      {"field": "income_label", "type": "nominal", "title": "Showing"},
      {
        "field": "income_before_housing",
        "type": "quantitative",
        "title": "Before Housing (£000s)",
        "format": ".2f"
      },
      {
        "field": "income_after_housing",
        "type": "quantitative",
        "title": "After Housing (£000s)",
        "format": ".2f"
      },
      {
        "field": "housing_cost",
        "type": "quantitative",
        "title": "Housing Cost (£000s)",
        "format": ".2f"
      },
      {
        "field": "housing_cost_pct",
        "type": "quantitative",
        "title": "Housing Cost (%)",
        "format": ".1f"
      }
    ]
  },
  "projection": {"type": "mercator"},
  "config": {}
}